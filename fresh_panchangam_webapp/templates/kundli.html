<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kundli Generator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1 { text-align: center; }
        form { max-width: 400px; margin: 0 auto; }
        label { display: block; margin-top: 1em; }
        input, select { width: 100%; padding: 0.5em; margin-top: 0.2em; }
        button { margin-top: 1em; padding: 0.7em 1.5em; }
        #result { max-width: 700px; margin: 2em auto; background: #f9f9f9; padding: 1em; border-radius: 8px; }
        .section { margin-bottom: 1.5em; }
        .section h2 { margin-bottom: 0.5em; }
        pre { background: #eee; padding: 1em; border-radius: 5px; }
        .kundli-diamond {
            width: 400px;
            height: 400px;
            margin: 2em auto;
            position: relative;
            background: #fffbe7;
            border: 2px solid #333;
        }
        .kundli-house {
            position: absolute;
            width: 100px;
            height: 100px;
            text-align: center;
            font-size: 1.1em;
            background: rgba(255,255,255,0.85);
            border-radius: 8px;
            box-sizing: border-box;
            padding-top: 18px;
        }
        .kundli-house .house-num {
            position: absolute;
            top: 2px;
            right: 6px;
            font-size: 0.9em;
            color: #888;
        }
        .kundli-house .lagna {
            color: red;
            font-weight: bold;
            font-size: 1.1em;
        }
        .kundli-house .planets {
            margin-top: 2px;
        }
        .kundli-house .sign {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <a href="/">
      <button type="button">Back to Panchangam</button>
    </a>
    <h1>Kundli Generator</h1>
    <form id="kundliForm">
        <label>Date of Birth:
            <input type="date" name="date" required>
        </label>
        <label>Time of Birth:
            <input type="time" name="time" required>
        </label>
        <label>Location:
            <input type="text" id="location-search" name="location-search" placeholder="Type to search..." autocomplete="off" required>
            <div id="autocomplete-list" style="border:1px solid #ccc; max-height:120px; overflow-y:auto; position:relative; background:white;"></div>
            <button type="button" id="use-current-location">Use My Location</button>
            <input type="hidden" name="location" id="location">
            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lon" id="lon">
            <input type="hidden" name="tz" id="tz">
            <div id="selected-location" style="margin-top:10px;"></div>
        </label>
        <label>Timezone (e.g. 5.5 for IST):
            <input type="number" name="tz-manual" id="tz-manual" step="any" placeholder="e.g. 5.5">
        </label>
        <button type="submit">Generate Kundli</button>
    </form>
    <div id="kundli-diamond-container"></div>
    <div id="kundli-chart" style="display:none;"></div>
    <div id="result" style="display:none;"></div>
    <script>
    // --- Autocomplete and geolocation logic ---
    let places = [];
    let usingCurrentLocation = false;

    function setLocationDisplay(name) {
        document.getElementById('selected-location').innerText = name ? `Selected location: ${name}` : '';
    }

    fetch('/get_places').then(r => r.json()).then(data => {
        places = data.places;
    });

    const locationInput = document.getElementById('location-search');
    const autocompleteList = document.getElementById('autocomplete-list');

    locationInput.addEventListener('input', function() {
        const val = this.value.trim().toLowerCase();
        autocompleteList.innerHTML = '';
        if (!val) return;
        const matches = places.filter(p => p.name.toLowerCase().includes(val) || (p.sa_name && p.sa_name.toLowerCase().includes(val)));
        matches.slice(0, 10).forEach(place => {
            const div = document.createElement('div');
            div.textContent = place.sa_name ? `${place.name} (${place.sa_name})` : place.name;
            div.style.cursor = 'pointer';
            div.onclick = function() {
                document.getElementById('location').value = place.name;
                document.getElementById('lat').value = place.lat;
                document.getElementById('lon').value = place.lon;
                document.getElementById('tz').value = '';
                locationInput.value = div.textContent;
                setLocationDisplay(div.textContent);
                autocompleteList.innerHTML = '';
                document.getElementById('tz-manual').value = place.TZFloat || '';
            };
            autocompleteList.appendChild(div);
        });
    });

    document.addEventListener('click', function(e) {
        if (e.target !== locationInput) autocompleteList.innerHTML = '';
    });

    document.getElementById('use-current-location').onclick = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                usingCurrentLocation = true;
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                document.getElementById('location').value = 'Current Location';
                locationInput.value = 'Current Location';
                setLocationDisplay('Current Location');
                document.getElementById('tz-manual').value = 5.5; // Default to IST
            }, function() {
                alert('Could not get your location.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    };

    // Set default to current location if available
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                usingCurrentLocation = true;
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                document.getElementById('location').value = 'Current Location';
                locationInput.value = 'Current Location';
                setLocationDisplay('Current Location');
                document.getElementById('tz-manual').value = 5.5;
            });
        }
    };

    function getPlanetGlyph(planet) {
        const glyphs = {
            'Sun': '☉', 'Moon': '☽', 'Mars': '♂', 'Mercury': '☿', 'Jupiter': '♃', 'Venus': '♀', 'Saturn': '♄',
            'Rahu (Mean)': '☊', 'Ketu (Mean)': '☋'
        };
        const devs = {
            'Sun': 'सूर्य', 'Moon': 'चन्द्र', 'Mars': 'मंगल', 'Mercury': 'बुध', 'Jupiter': 'गुरु', 'Venus': 'शुक्र', 'Saturn': 'शनि',
            'Rahu (Mean)': 'राहु', 'Ketu (Mean)': 'केतु'
        };
        return glyphs[planet] + ' ' + devs[planet];
    }

    function renderKundliDiamond(data) {
        // North Indian diamond house order (clockwise from top): 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9
        // SVG coordinates for house centers (relative to 400x400 SVG)
        const houseMap = {
            10: [200, 50], 11: [300, 100], 12: [350, 200], 1: [300, 300], 2: [200, 350], 3: [100, 300],
            4: [50, 200], 5: [100, 100], 6: [200, 200], 7: [250, 150], 8: [250, 250], 9: [150, 250]
        };
        // True North Indian order for houses (clockwise from top)
        const houseOrder = [10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9];

        // Map house number to bhava
        const bhavas = {};
        data.bhavas.forEach(bh => { bhavas[bh.house] = bh; });

        // Place planets in houses
        const planetHouses = {};
        Object.entries(data.planets).forEach(([planet, val]) => {
            // Find house for planet by degree
            let houseNum = 1;
            let minDiff = 360;
            data.bhavas.forEach(bh => {
                let diff = Math.abs(val.deg - bh.deg);
                if (diff < minDiff) { minDiff = diff; houseNum = bh.house; }
            });
            if (!planetHouses[houseNum]) planetHouses[houseNum] = [];
            planetHouses[houseNum].push(planet);
        });

        // Lagna house
        const lagnaHouse = 1;

        // SVG for diamond chart
        let svg = `<svg width="400" height="400" viewBox="0 0 400 400" style="background:#fffbe7; border:2px solid #333;">`;
        // Draw main diamond
        svg += `<polygon points="200,30 370,200 200,370 30,200" fill="none" stroke="#333" stroke-width="2"/>`;
        // Draw diagonals
        svg += `<line x1="200" y1="30" x2="200" y2="370" stroke="#333" stroke-width="2"/>`;
        svg += `<line x1="30" y1="200" x2="370" y2="200" stroke="#333" stroke-width="2"/>`;
        svg += `<line x1="100" y1="100" x2="300" y2="300" stroke="#333" stroke-width="2"/>`;
        svg += `<line x1="300" y1="100" x2="100" y2="300" stroke="#333" stroke-width="2"/>`;

        // Draw house diamonds
        const houseDiamond = (cx, cy, size, label, planets, sign, isLagna) => {
            let points = [
                [cx, cy - size],
                [cx + size, cy],
                [cx, cy + size],
                [cx - size, cy]
            ].map(p => p.join(',')).join(' ');
            let lagnaMark = isLagna ? '<tspan x="'+cx+'" dy="1.2em" fill="red" font-weight="bold">लग्न</tspan>' : '';
            let planetText = planets.map(getPlanetGlyph).join(' ');
            return `
                <polygon points="${points}" fill="#fff" stroke="#bbb" stroke-width="1"/>
                <text x="${cx}" y="${cy - size + 18}" text-anchor="middle" font-size="13" fill="#888">${label}</text>
                <text x="${cx}" y="${cy}" text-anchor="middle" font-size="16">${lagnaMark}${planetText}</text>
                <text x="${cx}" y="${cy + size - 10}" text-anchor="middle" font-size="11" fill="#666">${sign}</text>
            `;
        };

        // Place each house
        for (let i = 0; i < houseOrder.length; i++) {
            let h = houseOrder[i];
            let [cx, cy] = houseMap[h];
            let bh = bhavas[h];
            let planets = (planetHouses[h] || []);
            let isLagna = (h === lagnaHouse);
            svg += houseDiamond(cx, cy, 45, h, planets, bh ? bh.sign : '', isLagna);
        }
        svg += `</svg>`;

        // Add input summary above
        let input = data.input;
        let summary = `<div style='text-align:center; margin-bottom:1em;'><b>Date:</b> ${input.date} <b>Time:</b> ${input.time} <b>TZ:</b> ${input.tz}<br><b>Lat:</b> ${input.lat} <b>Lon:</b> ${input.lon}</div>`;
        document.getElementById('kundli-diamond-container').innerHTML = summary + svg;
    }

    document.getElementById('kundliForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            date: form.date.value,
            time: form.time.value,
            lat: form.lat.value,
            lon: form.lon.value,
            tz: form['tz-manual'].value // Always use the manual field
        };
        if (!data.lat || !data.lon) {
            alert('Latitude and longitude are required.');
            return;
        }
        if (!data.tz || isNaN(parseFloat(data.tz))) {
            alert('Please enter a valid numeric timezone (e.g. 5.5 for IST).');
            return;
        }
        document.getElementById('kundli-diamond-container').innerHTML = '<em>Generating kundli...</em>';
        try {
            const resp = await fetch('/api/kundli', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await resp.json();
            if (result.error) {
                document.getElementById('kundli-diamond-container').innerHTML = `<b>Error:</b> ${result.error}`;
                return;
            }
            renderKundliDiamond(result);
        } catch (err) {
            document.getElementById('kundli-diamond-container').innerHTML = `<b>Error:</b> ${err}`;
        }
    });
    </script>
</body>
</html> 