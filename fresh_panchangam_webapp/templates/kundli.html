<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kundli Generator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1 { text-align: center; }
        form { max-width: 400px; margin: 0 auto; }
        label { display: block; margin-top: 1em; }
        input, select { width: 100%; padding: 0.5em; margin-top: 0.2em; }
        button { margin-top: 1em; padding: 0.7em 1.5em; }
        #result { max-width: 700px; margin: 2em auto; background: #f9f9f9; padding: 1em; border-radius: 8px; }
        .section { margin-bottom: 1.5em; }
        .section h2 { margin-bottom: 0.5em; }
        pre { background: #eee; padding: 1em; border-radius: 5px; }
    </style>
</head>
<body>
    <a href="/">
      <button type="button">Back to Panchangam</button>
    </a>
    <h1>Kundli Generator</h1>
    <form id="kundliForm">
        <label>Date of Birth:
            <input type="date" name="date" required>
        </label>
        <label>Time of Birth:
            <input type="time" name="time" required>
        </label>
        <label>Location:
            <input type="text" id="location-search" name="location-search" placeholder="Type to search..." autocomplete="off" required>
            <div id="autocomplete-list" style="border:1px solid #ccc; max-height:120px; overflow-y:auto; position:relative; background:white;"></div>
            <button type="button" id="use-current-location">Use My Location</button>
            <input type="hidden" name="location" id="location">
            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lon" id="lon">
            <input type="hidden" name="tz" id="tz">
            <div id="selected-location" style="margin-top:10px;"></div>
        </label>
        <label>Timezone (e.g. 5.5 for IST):
            <input type="number" name="tz-manual" id="tz-manual" step="any" placeholder="e.g. 5.5">
        </label>
        <button type="submit">Generate Kundli</button>
    </form>
    <div id="kundli-chart" style="max-width: 500px; margin: 2em auto;"></div>
    <div id="result" style="display:none;"></div>
    <script>
    // --- Autocomplete and geolocation logic ---
    let places = [];
    let usingCurrentLocation = false;

    function setLocationDisplay(name) {
        document.getElementById('selected-location').innerText = name ? `Selected location: ${name}` : '';
    }

    fetch('/get_places').then(r => r.json()).then(data => {
        places = data.places;
    });

    const locationInput = document.getElementById('location-search');
    const autocompleteList = document.getElementById('autocomplete-list');

    locationInput.addEventListener('input', function() {
        const val = this.value.trim().toLowerCase();
        autocompleteList.innerHTML = '';
        if (!val) return;
        const matches = places.filter(p => p.name.toLowerCase().includes(val) || (p.sa_name && p.sa_name.toLowerCase().includes(val)));
        matches.slice(0, 10).forEach(place => {
            const div = document.createElement('div');
            div.textContent = place.sa_name ? `${place.name} (${place.sa_name})` : place.name;
            div.style.cursor = 'pointer';
            div.onclick = function() {
                document.getElementById('location').value = place.name;
                document.getElementById('lat').value = place.lat;
                document.getElementById('lon').value = place.lon;
                document.getElementById('tz').value = '';
                locationInput.value = div.textContent;
                setLocationDisplay(div.textContent);
                autocompleteList.innerHTML = '';
                document.getElementById('tz-manual').value = place.TZFloat || '';
            };
            autocompleteList.appendChild(div);
        });
    });

    document.addEventListener('click', function(e) {
        if (e.target !== locationInput) autocompleteList.innerHTML = '';
    });

    document.getElementById('use-current-location').onclick = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                usingCurrentLocation = true;
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                document.getElementById('location').value = 'Current Location';
                locationInput.value = 'Current Location';
                setLocationDisplay('Current Location');
                document.getElementById('tz-manual').value = 5.5; // Default to IST
            }, function() {
                alert('Could not get your location.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    };

    // Set default to current location if available
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                usingCurrentLocation = true;
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                document.getElementById('location').value = 'Current Location';
                locationInput.value = 'Current Location';
                setLocationDisplay('Current Location');
                document.getElementById('tz-manual').value = 5.5;
            });
        }
    };

    function getPlanetGlyph(planet) {
        // Devanagari or glyphs for planets
        const glyphs = {
            'Sun': '☉', 'Moon': '☽', 'Mars': '♂', 'Mercury': '☿', 'Jupiter': '♃', 'Venus': '♀', 'Saturn': '♄',
            'Rahu (Mean)': '☊', 'Ketu (Mean)': '☋'
        };
        const devs = {
            'Sun': 'सूर्य', 'Moon': 'चन्द्र', 'Mars': 'मंगल', 'Mercury': 'बुध', 'Jupiter': 'गुरु', 'Venus': 'शुक्र', 'Saturn': 'शनि',
            'Rahu (Mean)': 'राहु', 'Ketu (Mean)': 'केतु'
        };
        return glyphs[planet] + '<br>' + devs[planet];
    }

    function renderKundliChart(data) {
        // North Indian chart: houses are fixed, signs rotate
        // House order (starting from top, going anti-clockwise): 10, 11, 12, 1 (Lagna), 2, 3, 4, 5, 6, 7, 8, 9
        // We'll use a 4x4 grid for the diamond
        const houseOrder = [7, 8, 9, 10, 6, 1, 11, 5, 12, 2, 3, 4];
        const houseMap = {};
        data.bhavas.forEach(bh => { houseMap[bh.house] = bh; });
        // Place planets in houses
        const planetHouses = {};
        Object.entries(data.planets).forEach(([planet, val]) => {
            // Find house for planet by degree
            let houseNum = 1;
            let minDiff = 360;
            data.bhavas.forEach(bh => {
                let diff = Math.abs(val.deg - bh.deg);
                if (diff < minDiff) { minDiff = diff; houseNum = bh.house; }
            });
            if (!planetHouses[houseNum]) planetHouses[houseNum] = [];
            planetHouses[houseNum].push(planet);
        });
        // Lagna house
        const lagnaHouse = 1;
        // Build chart HTML
        let grid = [[],[],[],[]];
        // Map houseOrder to grid positions
        const pos = [ [0,0],[0,1],[0,2],[0,3], [1,0],[1,1],[1,2],[1,3], [2,0],[2,1],[2,2],[2,3], [3,0],[3,1],[3,2],[3,3] ];
        // House to grid mapping for diamond
        const houseToGrid = {
            10:[0,1], 11:[0,2], 12:[1,3], 1:[2,3], 2:[3,2], 3:[3,1], 4:[2,0], 5:[1,0], 6:[1,1], 7:[1,2], 8:[2,2], 9:[2,1]
        };
        let chart = '<div style="display:grid; grid-template-columns:repeat(4,1fr); grid-template-rows:repeat(4,1fr); gap:2px; width:400px; height:400px;">';
        for (let r=0; r<4; r++) {
            for (let c=0; c<4; c++) {
                // Find house for this cell
                let house = null;
                for (const [h, [rr,cc]] of Object.entries(houseToGrid)) {
                    if (rr==r && cc==c) { house = h; break; }
                }
                if (house) {
                    let bh = houseMap[house];
                    let lagnaMark = (house==lagnaHouse) ? '<span style="color:red;font-weight:bold;">लग्न</span><br>' : '';
                    let planets = (planetHouses[house]||[]).map(getPlanetGlyph).join('<br>');
                    chart += `<div style="border:1px solid #333; min-height:70px; text-align:center; font-size:1.1em; background:#fffbe7; position:relative;">
                        <div style='font-size:0.9em; color:#888; position:absolute; top:2px; right:4px;'>${house}</div>
                        ${lagnaMark}
                        ${planets}
                        <div style='font-size:0.8em; color:#666;'>${bh ? bh.sign : ''}</div>
                    </div>`;
                } else {
                    chart += '<div></div>';
                }
            }
        }
        chart += '</div>';
        // Add input summary above
        let input = data.input;
        let summary = `<div style='text-align:center; margin-bottom:1em;'><b>Date:</b> ${input.date} <b>Time:</b> ${input.time} <b>TZ:</b> ${input.tz}<br><b>Lat:</b> ${input.lat} <b>Lon:</b> ${input.lon}</div>`;
        document.getElementById('kundli-chart').innerHTML = summary + chart;
    }

    // --- Form submission ---
    document.getElementById('kundliForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            date: form.date.value,
            time: form.time.value,
            lat: form.lat.value,
            lon: form.lon.value,
            tz: form['tz-manual'].value // Always use the manual field
        };
        if (!data.lat || !data.lon) {
            alert('Latitude and longitude are required.');
            return;
        }
        if (!data.tz || isNaN(parseFloat(data.tz))) {
            alert('Please enter a valid numeric timezone (e.g. 5.5 for IST).');
            return;
        }
        document.getElementById('kundli-chart').innerHTML = '<em>Generating kundli...</em>';
        try {
            const resp = await fetch('/api/kundli', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await resp.json();
            if (result.error) {
                document.getElementById('kundli-chart').innerHTML = `<b>Error:</b> ${result.error}`;
                return;
            }
            renderKundliChart(result);
        } catch (err) {
            document.getElementById('kundli-chart').innerHTML = `<b>Error:</b> ${err}`;
        }
    });
    </script>
</body>
</html> 