<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kundli Generator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1 { text-align: center; }
        form { max-width: 400px; margin: 0 auto; }
        label { display: block; margin-top: 1em; }
        input, select { width: 100%; padding: 0.5em; margin-top: 0.2em; }
        button { margin-top: 1em; padding: 0.7em 1.5em; }
        #result { max-width: 700px; margin: 2em auto; background: #f9f9f9; padding: 1em; border-radius: 8px; }
        .section { margin-bottom: 1.5em; }
        .section h2 { margin-bottom: 0.5em; }
        pre { background: #eee; padding: 1em; border-radius: 5px; }
        .kundli-diamond {
            width: 400px;
            height: 400px;
            margin: 2em auto;
            position: relative;
            background: #fffbe7;
            border: 2px solid #333;
        }
        .kundli-house {
            position: absolute;
            width: 100px;
            height: 100px;
            text-align: center;
            font-size: 1.1em;
            background: rgba(255,255,255,0.85);
            border-radius: 8px;
            box-sizing: border-box;
            padding-top: 18px;
        }
        .kundli-house .house-num {
            position: absolute;
            top: 2px;
            right: 6px;
            font-size: 0.9em;
            color: #888;
        }
        .kundli-house .lagna {
            color: red;
            font-weight: bold;
            font-size: 1.1em;
        }
        .kundli-house .planets {
            margin-top: 2px;
        }
        .kundli-house .sign {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <a href="/">
      <button type="button">Back to Panchangam</button>
    </a>
    <h1>Kundli Generator</h1>
    <form id="kundliForm">
        <label>Date of Birth:
            <input type="date" name="date" required>
        </label>
        <label>Time of Birth:
            <input type="time" name="time" required>
        </label>
        <label>Location:
            <input type="text" id="location-search" name="location-search" placeholder="Type to search..." autocomplete="off" required>
            <div id="autocomplete-list" style="border:1px solid #ccc; max-height:120px; overflow-y:auto; position:relative; background:white;"></div>
            <button type="button" id="use-current-location">Use My Location</button>
            <input type="hidden" name="location" id="location">
            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lon" id="lon">
            <input type="hidden" name="tz" id="tz">
            <div id="selected-location" style="margin-top:10px;"></div>
        </label>
        <label>Timezone (e.g. 5.5 for IST):
            <input type="number" name="tz-manual" id="tz-manual" step="any" placeholder="e.g. 5.5">
        </label>
        <button type="submit">Generate Kundli</button>
    </form>
    <!-- Kundli Chart Section (Figma Autolayout) -->
<div class="frame-8-1" id="kundli-chart">
  <div class="4-2"><div class="4-3"></div></div>
  <div class="1-9"><div class="1-10"></div></div>
  <div class="7-16"><div class="7-17"></div></div>
  <div class="10-23"><div class="10-24"></div></div>
  <div class="2-30"><div class="2-31"></div></div>
  <div class="12-40"><div class="12-41"></div></div>
  <div class="6-50"><div class="6-51"></div></div>
  <div class="8-57"><div class="8-58"></div></div>
  <div class="3-64"><div class="3-65"></div></div>
  <div class="11-74"><div class="11-75"></div></div>
  <div class="5-84"><div class="5-85"></div></div>
  <div class="9-94"><div class="9-95"></div></div>
</div>

<!-- Add your Figma-exported CSS here or in a linked file -->
<link rel="stylesheet" href="styles.css">

<script>
let places = [];
let usingCurrentLocation = false;

function setLocationDisplay(name) {
    document.getElementById('selected-location').innerText = name ? `Selected location: ${name}` : '';
}

// Fetch places for autocomplete
fetch('/get_places').then(r => r.json()).then(data => {
    places = data.places;
});

const locationInput = document.getElementById('location-search');
const autocompleteList = document.getElementById('autocomplete-list');

locationInput.addEventListener('input', function() {
    const val = this.value.trim().toLowerCase();
    autocompleteList.innerHTML = '';
    if (!val) return;
    const matches = places.filter(p => p.name.toLowerCase().includes(val) || (p.sa_name && p.sa_name.toLowerCase().includes(val)));
    matches.slice(0, 10).forEach(place => {
        const div = document.createElement('div');
        div.textContent = place.sa_name ? `${place.name} (${place.sa_name})` : place.name;
        div.style.cursor = 'pointer';
        div.onclick = function() {
            document.getElementById('location').value = place.name;
            document.getElementById('lat').value = place.lat;
            document.getElementById('lon').value = place.lon;
            document.getElementById('tz').value = '';
            locationInput.value = div.textContent;
            setLocationDisplay(div.textContent);
            autocompleteList.innerHTML = '';
            document.getElementById('tz-manual').value = place.TZFloat || '';
        };
        autocompleteList.appendChild(div);
    });
});

document.addEventListener('click', function(e) {
    if (e.target !== locationInput) autocompleteList.innerHTML = '';
});

document.getElementById('use-current-location').onclick = function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            usingCurrentLocation = true;
            document.getElementById('lat').value = position.coords.latitude;
            document.getElementById('lon').value = position.coords.longitude;
            document.getElementById('location').value = 'Current Location';
            locationInput.value = 'Current Location';
            setLocationDisplay('Current Location');
            document.getElementById('tz-manual').value = 5.5; // Default to IST
        }, function() {
            alert('Could not get your location.');
        });
    } else {
        alert('Geolocation is not supported by this browser.');
    }
};

// Set default to current location if available
window.onload = function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            usingCurrentLocation = true;
            document.getElementById('lat').value = position.coords.latitude;
            document.getElementById('lon').value = position.coords.longitude;
            document.getElementById('location').value = 'Current Location';
            locationInput.value = 'Current Location';
            setLocationDisplay('Current Location');
            document.getElementById('tz-manual').value = 5.5;
        });
    }
};

// House number to inner div class mapping
const houseMap = {
  1: '.1-10',
  2: '.2-31',
  3: '.3-65',
  4: '.4-3',
  5: '.5-85',
  6: '.6-51',
  7: '.7-17',
  8: '.8-58',
  9: '.9-95',
  10: '.10-24',
  11: '.11-75',
  12: '.12-41'
};

// Optional: planet glyphs/Devanagari
function getPlanetGlyph(planet) {
  const glyphs = {
    'Sun': '☉ सूर्य', 'Moon': '☽ चन्द्र', 'Mars': '♂ मंगल', 'Mercury': '☿ बुध',
    'Jupiter': '♃ गुरु', 'Venus': '♀ शुक्र', 'Saturn': '♄ शनि',
    'Rahu (Mean)': '☊ राहु', 'Ketu (Mean)': '☋ केतु'
  };
  return glyphs[planet] || planet;
}

// Fill houses with planets from kundliData
function fillKundliHouses(kundliData) {
  for (let houseNum = 1; houseNum <= 12; houseNum++) {
    const selector = houseMap[houseNum];
    const div = document.querySelector(selector);
    div.innerHTML = '';
    // Add Lagna if this is the Lagna house
    if (kundliData.lagna && kundliData.lagna.house === houseNum) {
      const lagnaP = document.createElement('p');
      lagnaP.textContent = 'लग्न';
      lagnaP.style.fontWeight = 'bold';
      div.appendChild(lagnaP);
    }
    // Add planets
    (kundliData.houses && kundliData.houses[houseNum] || []).forEach(planet => {
      const p = document.createElement('p');
      p.textContent = getPlanetGlyph(planet);
      div.appendChild(p);
    });
  }
}

// Example: after receiving kundliData from backend
// fillKundliHouses(kundliData);
// You should call this after the API response is received.

document.getElementById('kundliForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        date: form.date.value,
        time: form.time.value,
        lat: form.lat.value,
        lon: form.lon.value,
        tz: form['tz-manual'].value // Always use the manual field
    };
    if (!data.lat || !data.lon) {
        alert('Latitude and longitude are required.');
        return;
    }
    if (!data.tz || isNaN(parseFloat(data.tz))) {
        alert('Please enter a valid numeric timezone (e.g. 5.5 for IST).');
        return;
    }
    document.getElementById('kundli-json').textContent = '';
    try {
        const resp = await fetch('/api/kundli', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await resp.json();
        if (result.error) {
            document.getElementById('kundli-json').textContent = `Error: ${result.error}`;
            return;
        }
        fillKundliHouses(result);
        document.getElementById('kundli-json').textContent = JSON.stringify(result, null, 2);
    } catch (err) {
        document.getElementById('kundli-json').textContent = `Error: ${err}`;
    }
});
</script>

<!-- Optionally, show JSON for debugging -->
<pre id="kundli-json" style="max-width: 700px; margin: 2em auto; background: #f9f9f9; padding: 1em; border-radius: 8px;"></pre>

</body>
</html> 