<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kundli Generator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1 { text-align: center; }
        form { max-width: 400px; margin: 0 auto; }
        label { display: block; margin-top: 1em; }
        input, select { width: 100%; padding: 0.5em; margin-top: 0.2em; }
        button { margin-top: 1em; padding: 0.7em 1.5em; }
        #result { max-width: 700px; margin: 2em auto; background: #f9f9f9; padding: 1em; border-radius: 8px; }
        .section { margin-bottom: 1.5em; }
        .section h2 { margin-bottom: 0.5em; }
        pre { background: #eee; padding: 1em; border-radius: 5px; }
    </style>
</head>
<body>
    <a href="/">
      <button type="button">Back to Panchangam</button>
    </a>
    <h1>Kundli Generator</h1>
    <form id="kundliForm">
        <label>Date of Birth:
            <input type="date" name="date" required>
        </label>
        <label>Time of Birth:
            <input type="time" name="time" required>
        </label>
        <label>Location:
            <input type="text" id="location-search" name="location-search" placeholder="Type to search..." autocomplete="off" required>
            <div id="autocomplete-list" style="border:1px solid #ccc; max-height:120px; overflow-y:auto; position:relative; background:white;"></div>
            <button type="button" id="use-current-location">Use My Location</button>
            <input type="hidden" name="location" id="location">
            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lon" id="lon">
            <input type="hidden" name="tz" id="tz">
            <div id="selected-location" style="margin-top:10px;"></div>
        </label>
        <label>Timezone (e.g. 5.5 for IST):
            <input type="number" name="tz-manual" id="tz-manual" step="any" placeholder="e.g. 5.5">
        </label>
        <button type="submit">Generate Kundli</button>
    </form>
    <div id="result"></div>
    <script>
    // --- Autocomplete and geolocation logic ---
    let places = [];
    let usingCurrentLocation = false;

    function setLocationDisplay(name) {
        document.getElementById('selected-location').innerText = name ? `Selected location: ${name}` : '';
    }

    fetch('/get_places').then(r => r.json()).then(data => {
        places = data.places;
    });

    const locationInput = document.getElementById('location-search');
    const autocompleteList = document.getElementById('autocomplete-list');

    locationInput.addEventListener('input', function() {
        const val = this.value.trim().toLowerCase();
        autocompleteList.innerHTML = '';
        if (!val) return;
        const matches = places.filter(p => p.name.toLowerCase().includes(val) || (p.sa_name && p.sa_name.toLowerCase().includes(val)));
        matches.slice(0, 10).forEach(place => {
            const div = document.createElement('div');
            div.textContent = place.sa_name ? `${place.name} (${place.sa_name})` : place.name;
            div.style.cursor = 'pointer';
            div.onclick = function() {
                document.getElementById('location').value = place.name;
                document.getElementById('lat').value = place.lat;
                document.getElementById('lon').value = place.lon;
                document.getElementById('tz').value = place.tz;
                locationInput.value = div.textContent;
                setLocationDisplay(div.textContent);
                autocompleteList.innerHTML = '';
                document.getElementById('tz-manual').value = place.tz === 'Asia/Calcutta' ? 5.5 : '';
            };
            autocompleteList.appendChild(div);
        });
    });

    document.addEventListener('click', function(e) {
        if (e.target !== locationInput) autocompleteList.innerHTML = '';
    });

    document.getElementById('use-current-location').onclick = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                usingCurrentLocation = true;
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                document.getElementById('location').value = 'Current Location';
                locationInput.value = 'Current Location';
                setLocationDisplay('Current Location');
                document.getElementById('tz-manual').value = 5.5; // Default to IST
            }, function() {
                alert('Could not get your location.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    };

    // Set default to current location if available
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                usingCurrentLocation = true;
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                document.getElementById('location').value = 'Current Location';
                locationInput.value = 'Current Location';
                setLocationDisplay('Current Location');
                document.getElementById('tz-manual').value = 5.5;
            });
        }
    };

    // --- Form submission ---
    document.getElementById('kundliForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            date: form.date.value,
            time: form.time.value,
            lat: form.lat.value,
            lon: form.lon.value,
            tz: form.tz.value || form['tz-manual'].value
        };
        if (!data.lat || !data.lon) {
            alert('Latitude and longitude are required.');
            return;
        }
        document.getElementById('result').innerHTML = '<em>Generating kundli...</em>';
        try {
            const resp = await fetch('/api/kundli', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await resp.json();
            if (result.error) {
                document.getElementById('result').innerHTML = `<b>Error:</b> ${result.error}`;
                return;
            }
            let html = '';
            html += `<div class='section'><h2>Input Details</h2><pre>${JSON.stringify(result.input, null, 2)}</pre></div>`;
            html += `<div class='section'><h2>Planets</h2><pre>${JSON.stringify(result.planets, null, 2)}</pre></div>`;
            html += `<div class='section'><h2>Lagna (Ascendant)</h2><pre>${JSON.stringify(result.lagna, null, 2)}</pre></div>`;
            html += `<div class='section'><h2>Bhavas (Houses)</h2><pre>${JSON.stringify(result.bhavas, null, 2)}</pre></div>`;
            document.getElementById('result').innerHTML = html;
        } catch (err) {
            document.getElementById('result').innerHTML = `<b>Error:</b> ${err}`;
        }
    });
    </script>
</body>
</html> 